---
title: "ETF Ownership"
author: "Jonathan Alexander Zeh"
date: "`r Sys.Date()`"
output:
  pdf_document:
  #html_document:
    #theme: cerulean
    #mainfont: Monaco
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
library(tidyverse)
library(ggplot2)
library(caTools)
library(dplyr)
library(purrr)
library(knitr)
library(readxl)
library(DescTools)
```

# data import
```{r, include = F}
df_raw = read_csv("/Users/jonathanzeh/Library/CloudStorage/OneDrive-Personal/BA_Thesis/BA_coding/datasets/eikon_data/variable_data/monthly_panel_v1.csv")

df_raw$date <- as.Date(df_raw$date)

df <- df_raw
```


# plots
## ETF ownership against stdev
```{r, include = F}
plot(x = df$ETF_ownership, y = df$monthly_std_dev, col = rgb(0, 0, 0, 0.3),
     #xlim = c(0, 0.2), ylim = c(0, 10),
     main = "ETF Ownership against Monthly Standard Deviation",
     ylab = "Monthly Standard Deviation",
     xlab = "ETF Ownership")
```


# clean data
## remove ETF_ownership outliers
```{r}
df <- df %>%
  filter(ETF_ownership <= 1 | is.na(ETF_ownership) == TRUE, na.rm = TRUE)
```

## handle zero values
```{r}
df$percent_of_traded_shares[df$percent_of_traded_shares == 0] <- NA
df$market_cap[df$market_cap == 0] <- NA
df$ETF_ownership[df$ETF_ownership == 0] <- NA
```


## min number of observations
```{r}
#lets only allow stocks with more than 20 observations
df$stock_RIC <- as.factor(df$stock_RIC)

observation_count <- df %>%
  mutate(observation = ifelse(is.na(monthly_std_dev) == TRUE, 0, 1)) %>%
  group_by(stock_RIC) %>%
  summarise(n_observations = sum(observation)) %>%
  filter(n_observations > 20)
              

### only keep observations that are in this data frame
stocks_to_keep <- observation_count$stock_RIC
df <- df %>%
  filter(stock_RIC %in% stocks_to_keep)
```

## winsorize ETF_ownership
```{r}
winsorize_var <- function(x, probs = c(0.02, 0.98)) {
  Winsorize(x, probs = probs, na.rm = TRUE)
}

df <- df %>%
  group_by(stock_RIC) %>%
  mutate(ETF_ownership_winsorized = winsorize_var(ETF_ownership),
         FUND_ownership_wisorized = winsorize_var(FUND_ownership),
         monthly_std_dev_winsorized = winsorize_var(monthly_std_dev),
         T1_monthly_std_dev_winzorized = winsorize_var(T1_monthly_std_dev),
         T2_monthly_std_dev_winzorized = winsorize_var(T2_monthly_std_dev),
         T3_monthly_std_dev_winzorized = winsorize_var(T3_monthly_std_dev))
```

## standardizing 
```{r}
df <- df %>%
  mutate(final_ETF_ownership = scale(ETF_ownership_winsorized),
         final_FUND_ownership = scale(FUND_ownership_wisorized),
         final_monthly_std_dev = scale(monthly_std_dev_winsorized),
         final_T1_monthly_std_dev = scale(T1_monthly_std_dev_winzorized),
         final_T2_monthly_std_dev = scale(T2_monthly_std_dev_winzorized),
         final_T3_monthly_std_dev = scale(T3_monthly_std_dev_winzorized))
```

## construct new variables
```{r}
df <- df %>%
  mutate(log_market_cap = log(market_cap),
         inv_price = 1/price)
```

## clean amihud_ratio
```{r}
df$amihud_ratio[is.infinite(df$amihud_ratio)] <- NA
```

# statistics
## summarize etf ownership
```{r}
# Extract the year from the date column
df <- df %>%
  mutate(year = format(date, "%Y"))

# Group by year and calculate the mean of the variable for each year
annual_mean <- df %>%
  group_by(year) %>%
  summarize(mean_ETF_ownership = mean(ETF_ownership, na.rm = TRUE) * 100,
            mean_ETF_ownership_outstanding = 
              mean(percent_of_traded_shares, na.rm = TRUE),
            percentage_diff = (mean_ETF_ownership_outstanding / mean_ETF_ownership) - 1)

colnames(annual_mean) = c("year", "mean ETF Ownership", 
                          "mean ETF ownership (windsorized)",
                          "deviation in percentage")
# View the result
kable(annual_mean)
```
## plot monthly mean
```{r}
df_clean <- df[!is.na(df$percent_of_traded_shares) & !is.na(df$market_cap) & df$market_cap > 0, ]

monthly_mean <- df_clean %>%
  group_by(date) %>%
  summarize(mean_shares_outstanding = 
            weighted.mean(percent_of_traded_shares, market_cap, na.rm = TRUE),
            mean_market_cap = weighted.mean(ETF_ownership, market_cap, na.rm = TRUE),
            FUND_mean_shares_outstanding = weighted.mean(FUND_percent_of_traded_shares,
                                                         market_cap, na.rm = TRUE),
            FUND_mean_market_cap = weighted.mean(FUND_ownership, market_cap, 
                                                 na.rm = TRUE))

monthly_mean
par(mfrow = c(1,2))
plot(x = monthly_mean$date, y = monthly_mean$mean_shares_outstanding, ylim = c(0, 26),
     main = "method: shares outstanding", ylab = "weighted mean", xlab = "months", 
     type = "l")
points(monthly_mean$date, y = monthly_mean$FUND_mean_shares_outstanding, col = "red",
      type = "l")
plot(x = monthly_mean$date, y = monthly_mean$mean_market_cap, ylim = c(0, 0.26),
     main = "method: market cap", ylab = "weighted mean", xlab = "months", 
     type = "l")
points(monthly_mean$date, y = monthly_mean$FUND_mean_market_cap, col = "red", 
       type = "l")

```
## monthly change in ETF and FUND ownership
```{r}
monthly_mean <- monthly_mean %>%
  mutate(change_ETF = diff(mean_shares_outstanding) / lag(mean_shares_outstanding, 1),
         change_FUND = diff(
           FUND_mean_shares_outstanding) / lag(FUND_mean_shares_outstanding, 1))

monthly_mean
plot(x = monthly_mean$date, y = monthly_mean$change_ETF, #ylim = c(0, 26),
     main = "Growth rates of weighted mean ownership", ylab = "Growth rates", xlab = "months", 
     type = "l")
points(monthly_mean$date, y = monthly_mean$change_FUND, col = "red",
      type = "l")
legend("topright",
       legend = c("ETFs", "Mutual Funds"),
       col = c("black", "red"),
       lty = 1)

```

## find stock that pushed etf ownership up in 2015-10-31
```{r}
df_subset <- df %>%
  filter(date == as.Date("2015-10-31") | date == as.Date("2015-09-30"))

comp <- df_subset %>%
  group_by(stock_RIC) %>%
  summarize(
    diff = round(
      (percent_of_traded_shares[date == as.Date("2015-10-31")] - 
       percent_of_traded_shares[date == as.Date("2015-09-30")]) / 
       percent_of_traded_shares[date == as.Date("2015-09-30")], 3)
  ) %>%
  arrange(desc(diff))

print(comp)
```

## Data quality
```{r, eval = F, include=F}
# Calculate the number of non-NA observations for each stock and each variable
df_summarized <- function(df){
  df <- df %>%
  group_by(stock_RIC) %>%
  summarise(across(everything(), ~ sum(!is.na(.)), .names = "non_na_{col}"))
  return(df)
}

library(openxlsx)

##### monthly panel
write.xlsx(df_summarized(df), 
          file = "/Users/jonathanzeh/Library/CloudStorage/OneDrive-Personal/BA_Thesis/BA_coding/R_exports/data_statistics/non_na_counts_monthly_panel.xlsx", 
          row.names = FALSE)

#### stock_level_data
write.xlsx(df_summarized(stock_level_data),
           file = "/Users/jonathanzeh/Library/CloudStorage/OneDrive-Personal/BA_Thesis/BA_coding/R_exports/data_statistics/non_na_counts_stock_level_data.xlsx", 
          row.names = FALSE)


#### check monthly st dev
monthly_st_dev <- read.csv("/Users/jonathanzeh/Library/CloudStorage/OneDrive-Personal/BA_Thesis/BA_coding/datasets/eikon_data/stock_level_data/monthly_st_dev.csv")

write.xlsx(df_summarized(monthly_st_dev), 
    file = "/Users/jonathanzeh/Library/CloudStorage/OneDrive-Personal/BA_Thesis/BA_coding/R_exports/data_statistics/non_na_counts_monthly_st_dev.xlsx", 
          row.names = FALSE)
```


# regression setups
## linear models
```{r, eval = F, include=F}
mod_1 <- lm(final_monthly_std_dev ~ final_ETF_ownership, data = df)
summary(mod_1)

mod_2 <- lm(final_monthly_std_dev ~ final_ETF_ownership + log_market_cap + 
                  inv_price + cumulative_return_12m  + amihud_ratio + FUND_ownership,
            data = df)
summary(mod_2)
```


## panel regression: time and entity fixed 
```{r, eval = F, include=F}
library(plm)

#######################################################
pdata <- pdata.frame(df, index = c("stock_RIC", "date"))
pdata$date <- as.Date(pdata$date)
pdata$month <- format(pdata$date, "%m")
#######################################################

# Convert month to a factor for fixed effects
pdata$month <- as.factor(pdata$month)

fe_model_1 <- plm(final_monthly_std_dev ~ final_ETF_ownership + log_market_cap + 
                  inv_price + cumulative_return_12m + amihud_ratio + final_FUND_ownership + monthly_relative_spread, 
                  data = pdata, model = "within")

fe_model_2 <- plm(final_monthly_std_dev ~ final_ETF_ownership + log_market_cap + 
                  inv_price + cumulative_return_12m  + amihud_ratio + final_FUND_ownership +
                    monthly_relative_spread + final_T1_monthly_std_dev +
                    final_T2_monthly_std_dev + final_T3_monthly_std_dev,
                  data = pdata, model = "within")

summary(fe_model_1)
summary(fe_model_2)
```
# regression functions
## fixed effects regression function
```{r}
library(plm)

fe_function <- function(df, start_year, end_year, volatility_lag = FALSE){
  ####################################################### sample split by period
  df_f <- df
  df_f$year <- format(df_f$date, "%Y")
  df_f <- df_f %>%
    filter(start_year <= year & year < end_year)
  
  
  ####################################################### plm object
  pdata <- pdata.frame(df_f, index = c("stock_RIC", "date"))
  pdata$date <- as.Date(pdata$date)
  pdata$month <- format(pdata$date, "%m")
  #######################################################

  # convert month to a factor for fixed effects
  pdata$month <- as.factor(pdata$month)
  
  if(volatility_lag == FALSE){
  fe_model <- plm(final_monthly_std_dev ~ final_ETF_ownership + log_market_cap +
                    inv_price + amihud_ratio + monthly_relative_spread +
                    cumulative_return_12m + final_FUND_ownership, 
                    data = pdata, model = "within")
  }
  
  if(volatility_lag == TRUE){
  fe_model <- plm(final_monthly_std_dev ~ final_ETF_ownership + log_market_cap +
                    inv_price + amihud_ratio + monthly_relative_spread +
                    cumulative_return_12m + final_FUND_ownership +
                    final_T1_monthly_std_dev + final_T2_monthly_std_dev +
                    final_T3_monthly_std_dev,
                    data = pdata, model = "within")
  }
  
  return(fe_model)
}
```

## implement fixed effects function
```{r}
data_on_fe_function <- function(df){
  fe_model_2009_2019 <- fe_function(df, 2009, 2020, volatility_lag = FALSE)
  fe_model_2009_2019_lag <- fe_function(df, 2009, 2020, volatility_lag = TRUE)
  
  fe_model_2020 <- fe_function(df, 2020, 2021, volatility_lag = FALSE)
  fe_model_2020_lag <- fe_function(df, 2020, 2021, volatility_lag = TRUE)
  
  fe_model_2021_2023 <- fe_function(df, 2021, 2024, volatility_lag = FALSE)
  fe_model_2021_2023_lag <- fe_function(df, 2021, 2024, volatility_lag = TRUE)
  
  fe_models_list <- list(fe_model_2009_2019, fe_model_2020, fe_model_2021_2023,
                         fe_model_2009_2019_lag, fe_model_2020_lag,
                         fe_model_2021_2023_lag)
  return(fe_models_list)
}
```

## stargazer function
```{r}
library(stargazer)

stargazer_function <- function(fe_models_list, variables, 
                               volatility_lag = FALSE, title_table, file_name) {
  folder_path = "/Users/jonathanzeh/Library/CloudStorage/OneDrive-Personal/BA_Thesis/BA_coding/R_exports/regression_outputs/"
  output_path = paste0(folder_path, file_name)
  
  if(volatility_lag == TRUE){
    mod_1 <- fe_models_list[[4]]
    mod_2 <- fe_models_list[[5]]
    mod_3 <- fe_models_list[[6]]
  } else {
    mod_1 <- fe_models_list[[1]]
    mod_2 <- fe_models_list[[2]]
    mod_3 <- fe_models_list[[3]]
  }
  
  latex_code <- stargazer(mod_1, mod_2, mod_3,
            
            type = "latex",
            title = title_table,
            dep.var.labels = c("Daily Volatility (t)"),
            column.labels = c("2010 to 2019", "2020", "2021 to 2023"),
            covariate.labels = variables,
            omit.stat = c("f", "ser"),
            add.lines = list(c("Month fixed effects", 
                               "Yes", "Yes", "Yes"),
                             c("Stock fixed effects", 
                               "Yes", "Yes", "Yes")),
            out = output_path)
}
```

### running regressions
```{r, echo = False}
#################################################################
# Data: df, Type: no lag, Index: FALSE
#################################################################
fe_models_list_no_lag <- data_on_fe_function(df)

variables_no_lag <- c("ETF ownership", "log(Mktcap t-1)", "1/Price t-1", 
                      "Amihud t-1", "Bid-ask spread t-1", 
                      "Past 12-month returns t-1", "Fund ownership t-1")

stargazer_function(fe_models_list_no_lag, variables_no_lag, FALSE,
                   "Data: df, Type: no lag, Index: FALSE", "table_df_no_lag.tex")

#################################################################
# Data: df, Type: lag, Index: FALSE
#################################################################
fe_models_list_lag <- data_on_fe_function(df)

variables_lag <- c("ETF ownership", "log(Mktcap t-1)", "1/Price t-1", 
                      "Amihud t-1", "Bid-ask spread t-1", 
                      "Past 12-month returns t-1", "Fund ownership t-1", 
                      "Volatility t-1", "Volatility t-2", "Volatility t-3")

stargazer_function(fe_models_list_lag, variables_lag, TRUE,
                   "Data: df, Type: lag, Index: FALSE", "table_df_lag.tex")
```








---
title: "Panel Regression"
author: "Jonathan Alexander Zeh"
date: "`r Sys.Date()`"
output:
  pdf_document:
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
library(tidyverse)
library(ggplot2)
library(caTools)
library(dplyr)
library(purrr)
library(knitr)
library(readxl)
library(DescTools)
library(fixest)
```

# data preperation functions
## data import
```{r, include = F}
data_import_func <- function(path){
  df_raw = read_csv(path, show_col_types = FALSE)
  df_raw$date <- as.Date(df_raw$date)
  df <- df_raw
  return(df)
}
```

## data manipulation
### Change zero values to NA
```{r}
handle_zero_vals_func <- function(df){
  df$percent_of_traded_shares[df$percent_of_traded_shares == 0] <- NA
  df$ETF_ownership[df$ETF_ownership == 0] <- NA
  df$market_cap[df$market_cap == 0] <- NA
  df$amihud_ratio[is.infinite(df$amihud_ratio)] <- NA
  df$monthly_std_dev[df$count_returns < 12] <- NA
  return(df)
}
```

### Min Number of Observations
```{r}
min_obersevations_func <- function(df){
  #lets only allow stocks with more than 12 observations
  df$stock_RIC <- as.factor(df$stock_RIC)

  observation_count <- df %>%
    mutate(observation = ifelse(is.na(monthly_std_dev) == FALSE &
                                  index_member_600 == 1, 1, 0)) %>%
    group_by(stock_RIC) %>%
    summarise(n_observations = sum(observation)) %>%
    filter(n_observations >= 12)
              
  ### only keep observations that are in this data frame
  stocks_to_keep <- observation_count$stock_RIC
  df <- df %>%
    filter(stock_RIC %in% stocks_to_keep)
 return(df) 
}
```

### Construct Variables
```{r}
var_construction_func <- function(df){
  df <- df %>%
  mutate(log_market_cap = log(market_cap),
         inv_price = 1/price,
         index_member_600_ex_50 = ifelse(
           index_member_600 == 1 & index_member_50 == 0, 1, 0))
  return(df)
}
```

### Handle NAs for Standardization
```{r}
# Define the function
set_row_na_if_any_na_func <- function(df) {

  columns_not_to_set_na <- c("date", "stock_RIC", "index_member_600",
                             "index_member_50",
                             "index_member_600_ex_50", "year_month")
  columns_to_check <- c("percent_of_traded_shares", "FUND_percent_of_traded_shares",
                      "INDEX_FUND_percent_of_traded_shares",
                       "ACTIVE_FUND_percent_of_traded_shares",
                       "log_market_cap", "inv_price", "amihud_ratio",
                      "monthly_relative_spread", "monthly_std_dev",
                      "T1_monthly_std_dev","T2_monthly_std_dev",
                      "T3_monthly_std_dev")
  
  # Get all column names
  all_columns <- colnames(df)
  
  # Determine columns to set to NA by excluding columns_not_to_set_na
  columns_to_set_na <- setdiff(all_columns, columns_not_to_set_na)
  
  # Create a logical vector to identify rows with NA in the columns_to_check
  rows_with_na <- rowSums(is.na(df[, columns_to_check])) > 0
  
  # Set the specified columns to NA for the identified rows
  df[rows_with_na, columns_to_set_na] <- NA
  
  return(df)
}
```

### Index Subsets
```{r}
# define winsorize function
winsorize_var <- function(x, probs = c(0.01, 0.99)) {
  Winsorize(x, probs = probs, na.rm = TRUE)
}

# take subsets for different index specifications
non_index_members_to_NA <- function(col_name, df) {
  outlier_rows <- which(df[[col_name]] == 0)

  # replace entire rows with NA where an outlier is detected
  if (length(outlier_rows) > 0) {
    df[outlier_rows, -(1:4)] <- NA
  }
  
  df <- df %>%
    group_by(stock_RIC) %>%
    mutate(final_ETF_ownership = 
           scale(winsorize_var(percent_of_traded_shares/100)),
         final_FUND_ownership =
           scale(winsorize_var(FUND_percent_of_traded_shares/100)),
         final_INDEX_FUND_ownership =
           scale(winsorize_var(INDEX_FUND_percent_of_traded_shares/100)),
         final_ACTIVE_FUND_ownership =
           scale(winsorize_var(ACTIVE_FUND_percent_of_traded_shares/100)),
         final_monthly_std_dev = scale(winsorize_var(monthly_std_dev)),
         final_T1_monthly_std_dev = scale(winsorize_var(T1_monthly_std_dev)),
         final_T2_monthly_std_dev = scale(winsorize_var(T2_monthly_std_dev)),
         final_T3_monthly_std_dev = scale(winsorize_var(T3_monthly_std_dev)),
         price_to_BV = winsorize_var(price_to_BV))
  
  return(df)
}
```

# Main Data Preperation
```{r}
main <- function(path){
  df <- data_import_func(path)
  df <- handle_zero_vals_func(df)
  df <- min_obersevations_func(df)
  df <- var_construction_func(df)
  df <- set_row_na_if_any_na_func(df)
  return(df)
}
```

## Sample: Standard
```{r}
df <- main("/Users/jonathanzeh/Library/CloudStorage/OneDrive-Personal/BA_Thesis/BA_coding/datasets/eikon_data/variable_data/monthly_panel_v1_all.csv")

df_600 <- non_index_members_to_NA("index_member_600", df)
df_600_ex_50 <- non_index_members_to_NA("index_member_600_ex_50", df)
df_50 <- non_index_members_to_NA("index_member_50", df)
```

## Sample: Europe
```{r}
df_eu <- main("/Users/jonathanzeh/Library/CloudStorage/OneDrive-Personal/BA_Thesis/BA_coding/datasets/eikon_data/variable_data/monthly_panel_v1_europe_van.csv")

df_600_eu <- non_index_members_to_NA("index_member_600", df_eu)
df_600_ex_50_eu <- non_index_members_to_NA("index_member_600_ex_50", df_eu)
df_50_eu <- non_index_members_to_NA("index_member_50", df_eu)
```

# Statistics
## Ownership Statistics Function
```{r}
annual_fund_ownership_func <- function(df, type = "none") {
  # extract the year from the date column
  df_clean <- df[!is.na(df$percent_of_traded_shares) & !is.na(df$market_cap) & 
             df$market_cap > 0, ]
  
  # Group by year and calculate the mean of the variable for each year
  df_monthly_ownership <- df_clean %>%
    group_by(date) %>%
    summarize(etf_1 = weighted.mean(ETF_ownership, 
                                             market_cap, na.rm = TRUE) * 100,
              etf_2 = weighted.mean(percent_of_traded_shares, market_cap,
                                          na.rm = TRUE),
              etf_stock_mean = mean(percent_of_traded_shares, na.rm = TRUE),
              etf_stock_median = median(percent_of_traded_shares, 
                                         na.rm = TRUE),
              etf_market_cap = sum(stock_value_held, na.rm = TRUE)/1000,
              
              fund_1 = weighted.mean(FUND_ownership, market_cap,
                                                 na.rm = TRUE) * 100,
              fund_2 = weighted.mean(FUND_percent_of_traded_shares, market_cap,
                                     na.rm = TRUE),
              fund_market_cap = sum(FUND_stock_value_held, na.rm = TRUE)/1000,
              
              index_fund_1 = weighted.mean(INDEX_FUND_ownership, market_cap,
                                                 na.rm = TRUE) * 100,
              index_fund_2 = weighted.mean(INDEX_FUND_percent_of_traded_shares,
                                           market_cap, na.rm = TRUE),
              index_fund_mean = mean(INDEX_FUND_percent_of_traded_shares, 
                                     na.rm = TRUE),
              index_fund_median = median(INDEX_FUND_percent_of_traded_shares, 
                                         na.rm = TRUE),
              index_fund_market_cap = sum(INDEX_FUND_stock_value_held, 
                                          na.rm = TRUE)/1000,
              
              active_fund_1 = weighted.mean(ACTIVE_FUND_ownership, market_cap,
                                                 na.rm = TRUE) * 100,
              active_fund_2 =
                weighted.mean(ACTIVE_FUND_percent_of_traded_shares,
                              market_cap, na.rm = TRUE),
              active_fund_mean = mean(ACTIVE_FUND_percent_of_traded_shares, 
                                      na.rm = TRUE),
              active_fund_median = median(ACTIVE_FUND_percent_of_traded_shares, 
                                         na.rm = TRUE),
              active_fund_market_cap = sum(ACTIVE_FUND_stock_value_held, 
                                           na.rm = TRUE)/1000,
              std_dev = weighted.mean(monthly_std_dev, market_cap, 
                                       na.rm = TRUE),
              total_market_cap = sum(market_cap, na.rm = TRUE)/(1000000000),
              .groups = "drop")
  
  df_monthly_ownership$date <- as.character(df_monthly_ownership$date)
  df_monthly_ownership <- df_monthly_ownership %>% 
    mutate_if(is.numeric, round, digits = 2)

  df_monthly_ownership <- df_monthly_ownership %>%
    arrange(date)
  
  if(type == "monthly"){
    df_monthly_ownership <- df_monthly_ownership %>%
      mutate(date = as.factor(format(as.Date(date), "%Y-%m")))
    return(df_monthly_ownership)
  }
  
  ###########
  df_monthly_ownership <- df_monthly_ownership %>%
    mutate(year = as.factor(format(as.Date(date), "%Y")))
  

  df_yearly_ownership <- df_monthly_ownership %>%
    group_by(year) %>%
    summarize(etf_2 = mean(etf_2),
              etf_stock_mean = mean(etf_stock_mean),
              etf_market_cap = mean(etf_market_cap),
              index_fund_2 = mean(index_fund_2),
              index_fund_mean = mean(index_fund_mean),
              index_fund_market_cap = mean(index_fund_market_cap),
              active_fund_2 = mean(active_fund_2),
              active_fund_mean = mean(active_fund_mean),
              active_fund_market_cap = mean(active_fund_market_cap)
    )
  
  df_yearly_ownership <- df_yearly_ownership %>% 
    mutate_if(is.numeric, round, digits = 2)
  return(df_yearly_ownership)
}
```

### Ownership Calculation
```{r}
# Yearly Fund Ownership Data
# -------------------------------------------------------------------
yearly_df_600 <- annual_fund_ownership_func(df_600)
yearly_df_50 <- annual_fund_ownership_func(df_50)
yearly_df_600_ex_50 <- annual_fund_ownership_func(df_600_ex_50)

# Monthly Fund Ownership Data
# -------------------------------------------------------------------
monthly_df_50 <- annual_fund_ownership_func(df_50, type = "monthly")
monthly_df_600 <- annual_fund_ownership_func(df_600, type = "monthly")
monthly_df_600_ex_50 <- annual_fund_ownership_func(df_600_ex_50, 
                                                   type = "monthly")

# Mean Fund Ownership across Years
# -------------------------------------------------------------------
calculate_means_for_periods <- function(data, periods) {
  
  results <- data.frame(Period = character(),
                        Mean = numeric(), 
                        stringsAsFactors = FALSE)

  for (period in periods) {
    start_year <- period[1]
    end_year <- period[2]
    
    filtered_values <- data$etf_stock_mean[data$year >= start_year &
                                             data$year <= end_year]
    
    mean_value <- mean(filtered_values, na.rm = TRUE)
    
    period_name <- paste(start_year, end_year, sep = "-")
    results <- rbind(results, data.frame(Period = period_name, 
                                         Mean = mean_value))
  }

  return(results)
}

#date columns prep for function
yearly_df_600$year <- as.numeric(as.character(yearly_df_600$year))
yearly_df_50$year <- as.numeric(as.character(yearly_df_50$year))
yearly_df_600_ex_50$year <- as.numeric(as.character(yearly_df_600_ex_50$year))
yearly_df_600_eu$year <- as.numeric(as.character(yearly_df_600_eu$year))

# Calculate the mean for different periods (STOXX 600)
time_periods <- list(c(2011, 2014), c(2015, 2019), c(2020, 2023))
STOXX_600_means <- calculate_means_for_periods(data = yearly_df_600,
                                               periods = time_periods)

# Calculate the mean for different periods (STOXX 50)
time_periods <- list(c(2011, 2014), c(2015, 2019), c(2020, 2023))
STOXX_50_means <- calculate_means_for_periods(data = yearly_df_50,
                                               periods = time_periods)

STOXX_600_means = cbind(STOXX_600_means, STOXX_50_means$Mean)

# Calculate the mean for different periods (STOXX 600 ex 50)
time_periods <- list(c(2011, 2014), c(2015, 2019), c(2020, 2023))
STOXX_600_ex_50_means <- calculate_means_for_periods(
  data = yearly_df_600_ex_50, periods = time_periods)

# Calculate the mean for different periods (STOXX 600 eu)
time_periods <- list(c(2011, 2014), c(2015, 2019), c(2020, 2023))
STOXX_600_eu_means <- calculate_means_for_periods(
  data = yearly_df_600_eu, periods = time_periods)
```

### Latex Table
```{r}
# Support Functions
# ------------------------------------------------------
formatCurrency <- function(x) {
  paste0('â‚¬', formatC(x, format = 'f', digits = 1, big.mark = ','))
}

formatPercentage <- function(x) {
  paste0(formatC(x, format = 'f', digits = 2), '%')
}

applyFormatting <- function(data, columns, formatter) {
  for (column in columns) {
    data[[column]] <- formatter(data[[column]])
  }
  return(data)
}

# Main Function to create Latex Table
# ------------------------------------------------------
fund_ownership_table_func <- function(df){
  # Columns formatted as currency
  currency_cols <- c("etf_market_cap", "index_fund_market_cap",
                     "active_fund_market_cap")
  df <- applyFormatting(df, currency_cols, formatCurrency)
  
  # Columns formatted as percentages
  percentage_cols <- c("etf_2", "etf_stock_mean", "index_fund_2", 
                       "index_fund_mean", "active_fund_2", "active_fund_mean")
  df <- applyFormatting(df, percentage_cols, formatPercentage)
  
  # Creating LaTeX table
  latex_table <- kable(df[, c("year", "etf_2", 
                              "etf_stock_mean",
                              "etf_market_cap",
                              "index_fund_2",
                              "index_fund_mean",
                              "index_fund_market_cap",
                              "active_fund_2",
                              "active_fund_mean",
                              "active_fund_market_cap")],
                       format = "latex", booktabs = TRUE)
  
  return(cat(latex_table))
}
```

## Main Ownership Statistics
```{r}
## df_600_eu
df_600_eu_statistic <- annual_fund_ownership_func(df_600_eu)
fund_ownership_table_func(df_600_eu_statistic)

## df_50
df_50_statistic <- annual_fund_ownership_func(df_50)
fund_ownership_table_func(df_50_statistic)

## df_600
df_600_statistic <- annual_fund_ownership_func(df_600)
fund_ownership_table_func(df_600_statistic)

## df_600_ex_50
df_600_ex_50_statistic <- annual_fund_ownership_func(df_600_ex_50)
fund_ownership_table_func(df_600_ex_50_statistic)
```

## Number of Stocks of Time
```{r}
number_of_stocks_func <- function(df){
  #lets only allow stocks with more than 12 observations
  df$stock_RIC <- as.factor(df$stock_RIC)
  
  # set all NAs to FALSE
  observation_count <- df %>%
    mutate(year = as.factor(format(date, "%Y")),
           observation = ifelse(
             is.na(monthly_std_dev) == FALSE &
               is.na(percent_of_traded_shares) == FALSE &
               is.na(FUND_percent_of_traded_shares) == FALSE &
               is.na(INDEX_FUND_percent_of_traded_shares) == FALSE &
               is.na(ACTIVE_FUND_percent_of_traded_shares) == FALSE &
               is.na(log_market_cap) == FALSE &
               is.na(amihud_ratio) == FALSE &
               is.na(price_to_BV) == FALSE &
               is.na(inv_price) == FALSE &
               is.na(FUND_percent_of_traded_shares) == FALSE &
               is.na(cumulative_return_12m) == FALSE &
               is.na(monthly_relative_spread) == FALSE &
               index_member_600 == 1, 1, 0)) %>%
    group_by(year) %>%
    summarise(n_observations = sum(observation))
  
 return(observation_count) 
}

# Apply function to count observations
# --------------------------------------------------------
df_observation_num <- number_of_stocks_func(df_600)
df_observation_num <- cbind(df_observation_num, number_of_stocks_func(df_50))

colnames(df_observation_num) <- c("date1", "STOXX_600", "date2", "STOXX_50")

df_observation_num <- df_observation_num %>%
  arrange(date1) %>%
  slice(-2)

# Total Observations
sum(df_observation_num$STOXX_600)
sum(df_observation_num$STOXX_50)
```


## Correlation Matrix
```{r}
selected_variables <- c("monthly_std_dev", "percent_of_traded_shares",
                        "log_market_cap", "inv_price",
                     "amihud_ratio","monthly_relative_spread",
                     "price_to_BV", "cumulative_return_12m",
                     "FUND_percent_of_traded_shares",
                     "INDEX_FUND_percent_of_traded_shares",
                     "ACTIVE_FUND_percent_of_traded_shares")

df <- df_50[, selected_variables]
df <- na.omit(df)
corr_matrix_df_50 <- round(cor(df), 3)

variable_labels <- c("Daily Volatility", "ETF ownership", "log(Mktcap)", "1/Price",
                     "Amihud ratio", "Bid-ask spread", "Price to book", 
                     "Past 12-month returns", "Fund ownership", 
                     "Index fund ownership", "Active fund ownership")

rownames(corr_matrix_df_50) <- variable_labels
upper.tri(corr_matrix_df_50)

upper<-corr_matrix_df_50
upper[upper.tri(corr_matrix_df_50)]<-""
upper<-as.data.frame(upper)
print(upper)

cat(kable(upper, format = "latex", booktabs = TRUE))
```


## Summary Statistics
```{r}
## data: df_outstanding
library(dplyr)
library(tidyr)

calculate_summary_statistics <- function(df, row_names) {
  df_summary_statistics <- tibble(
    n = rep(nrow(df_summary), ncol(df_summary)),
    mean = sapply(df_summary, mean, na.rm=TRUE),
    sd = sapply(df_summary, sd),
    min = sapply(df_summary, min),
    median = sapply(df_summary, median),
    max = sapply(df_summary, max)) %>%
      round(3)
  
  df_summary_statistics <- data.frame(df_summary_statistics)
  rownames(df_summary_statistics) <- row_names 


  return(df_summary_statistics)
}

# List of variables to include
row_names <- c("Daily Volatility", "ETF ownership", "log(Mktcap)", 
               "1/Price", "Amihud", 
               "Bid-ask spread", "Price to Book", "Past 12-month returns", 
               "Fund ownership", 
               "Index fund ownership", "Active fund ownership", 
               "5% Left Tail", "5% Right Tail", "Skewness")

df_f <- df_600[, -c(2)]
df_summary <- df_f %>%
    select(monthly_std_dev, ETF_ownership, log_market_cap,
           inv_price, amihud_ratio, monthly_relative_spread, price_to_BV,
           cumulative_return_12m, FUND_ownership,
           INDEX_FUND_ownership, ACTIVE_FUND_ownership,
           min_monthly_return, max_monthly_return, skewness) %>%
  na.omit()

df_summary_statistics <- calculate_summary_statistics(df_summary, row_names)

########## exporting as tex file
library(stargazer)

summary_text = "The table presents the statistics for variables used in this study. The sample covers the periode from January 2011 to November 2023. This data contain survior-ship bias for stocks, that are no longer listed."

stargazer(df_summary_statistics, type = "latex", 
          title = "Summary Statistics for Monthly Sample",
          summary = FALSE,
          header = FALSE,
          out = "/Users/jonathanzeh/Library/CloudStorage/OneDrive-Personal/BA_Thesis/BA_coding/R_exports/summary_statistics/summary_statistics.tex")
```




# Panel Regressions
## Functions
### Func Panel Regression
```{r}
library(fixest)
library(dplyr)

fe_function <- function(df,
                        indep_vars, fixed_vars,
                        periode_vec,
                        setup = setup,
                        volatility_lag = FALSE, 
                        fund_consolidation = FALSE,
                        depend_var = NA,
                        interaction_config = NA){
  ################################################### sample split by period
  df_f <- df %>%
    mutate(year = as.numeric(format(date, "%Y"))) %>%
    filter(periode_vec[1] <= year & year < periode_vec[2]) 
  
  df_f <- df_f %>%
    group_by(stock_RIC) %>%
    mutate(final_ETF_ownership = 
           scale(winsorize_var(percent_of_traded_shares/100)),
         final_FUND_ownership =
           scale(winsorize_var(FUND_percent_of_traded_shares/100)),
         final_INDEX_FUND_ownership =
           scale(winsorize_var(INDEX_FUND_percent_of_traded_shares/100)),
         final_ACTIVE_FUND_ownership =
           scale(winsorize_var(ACTIVE_FUND_percent_of_traded_shares/100)),
         final_monthly_std_dev = scale(winsorize_var(monthly_std_dev)),
         final_T1_monthly_std_dev = scale(winsorize_var(T1_monthly_std_dev)),
         final_T2_monthly_std_dev = scale(winsorize_var(T2_monthly_std_dev)),
         final_T3_monthly_std_dev = scale(winsorize_var(T3_monthly_std_dev)))
    
  ####################################################### subset
  if(setup == "lag_fund"){
    vars_to_exclude <- c()    
    if(volatility_lag == FALSE){
      vars_to_exclude <- c(vars_to_exclude, 
                           "final_T1_monthly_std_dev",
                           "final_T2_monthly_std_dev",
                           "final_T3_monthly_std_dev")
    }
    if(fund_consolidation == TRUE){
      vars_to_exclude <- c(vars_to_exclude, 
                           "final_INDEX_FUND_ownership",
                           "final_ACTIVE_FUND_ownership")
    }
    if(fund_consolidation == FALSE){
      vars_to_exclude <- c(vars_to_exclude,
                           "final_FUND_ownership")
    }
    indep_vars <- indep_vars[!indep_vars %in% vars_to_exclude]
  }
  
  if(setup == "lag"){
    vars_to_exclude <- c() 
    if(volatility_lag == FALSE){
      vars_to_exclude <- c(vars_to_exclude, 
                           "final_T1_monthly_std_dev",
                           "final_T2_monthly_std_dev",
                           "final_T3_monthly_std_dev")
    }
    indep_vars <- indep_vars[!indep_vars %in% vars_to_exclude]
  }
  
  if(setup == "fund"){
    vars_to_exclude <- c() 
    if(fund_consolidation == TRUE){
      vars_to_exclude <- c(vars_to_exclude, 
                           "final_INDEX_FUND_ownership",
                           "final_ACTIVE_FUND_ownership")
    }
    if(fund_consolidation == FALSE){
      vars_to_exclude <- c(vars_to_exclude,
                           "final_FUND_ownership")
    }
    indep_vars <- indep_vars[!indep_vars %in% vars_to_exclude]
  }

  ####################################################### formula string
  if(all(is.na(depend_var)) == TRUE){
    depend_var = "final_monthly_std_dev ~"
  } else {
    depend_var = paste(depend_var, " ~")
  }
  
  if((is.na(interaction_config)) == TRUE){
    indep_vars_string <- paste(indep_vars, collapse = " + ")
  } else {
    indep_vars_string <- paste("final_ETF_ownership : bad_times +", 
                               indep_vars[!(indep_vars %in% 
                                              c("bad_times"))], 
                               collapse = " + ")
  }
  
  fixed_effects_string <- paste(fixed_vars, collapse = " + ")
  
  if(all(is.na(fixed_vars)) == TRUE){
    formula_string <- paste(depend_var, 
                          indep_vars_string)
  } else {
    formula_string <- paste(depend_var, 
                          indep_vars_string, "|", 
                          fixed_effects_string)
  }
  
  model_formula <- as.formula(formula_string)
  
  ####################################################### data prep
  df_f$date <- as.Date(df_f$date)
  df_f$stock_RIC <- as.factor(df_f$stock_RIC)
  df_f$month <- as.factor(format(df_f$date, "%m"))
  df_f$year <- as.factor(df_f$year)
  df_f$quarter <- as.factor(quarters(df_f$date))
  
  ####################################################### regression
  fe_model <- feols(model_formula, data = df_f)
  
  return(fe_model)
}
```

### Func create tables
```{r}
data_on_fe_function <- function(df,
                                indep_vars, fixed_vars, 
                                periode_list, setup = "lag") {
  generate_models <- function(period, df,
                              indep_vars, fixed_vars, setup) {
    models_list <- list()
    
    # Add base model
    if(setup == "single"){
      models_list[['fe_model']] <- fe_function(
      df, indep_vars, fixed_vars, period, setup)
    } else if(setup == "lag"){
      models_list[['fe_model']] <- fe_function(
      df, indep_vars, fixed_vars, period, setup, volatility_lag = FALSE)
    } else if(setup == "fund"){
      models_list[['fe_model']] <- fe_function(
      df, indep_vars, fixed_vars, period, setup, fund_consolidation = FALSE)
    } else {
      models_list[['fe_model']] <- fe_function(
      df, indep_vars, fixed_vars, period, setup, volatility_lag = FALSE,
      fund_consolidation = FALSE)
    }
    
    
    if(setup == "lag" || setup == "lag_fund") {
      # Add lag model
      models_list[['fe_model_lag']] <- fe_function(
        df, indep_vars, fixed_vars, period, setup, volatility_lag = TRUE,
        fund_consolidation = FALSE)
    }
    
    if(setup == "fund" || setup == "lag_fund") {
      # Add fund model
      models_list[['fe_model_fund']] <- fe_function(
        df, indep_vars, fixed_vars, period, setup, 
        volatility_lag = TRUE, fund_consolidation = TRUE)
    }
    
    return(models_list)
  }
  
  # Generate models for each period
  models <- lapply(periode_list, generate_models, df = df, 
                   indep_vars = indep_vars, fixed_vars = fixed_vars, 
                   setup = setup)
  
  model_names <- c()
  fe_models_list <- list()
  
  for (i in seq_along(models)) {
    for (model_type in names(models[[i]])) {
      model_name <- paste("fe_model", i, model_type, sep = "_")
      fe_models_list[[model_name]] <- models[[i]][[model_type]]
      model_names <- c(model_names, model_name)
    }
  }
  names(fe_models_list) <- model_names
  
  return(fe_models_list)
}
```


### Func etable
```{r}
library(fixest)
library(tinytex)
library(pdftools)

style_df <- style.df(depvar.title = "", fixef.title = "", stats.title = "",
                     yesNo = c("Yes", "No"))

etable_function <- function(fe_models_list, cluster = NA, 
                            title, sub_sample,
                            subfolder, file_name) {
  
  ######################## path string
  folder_path = "/Users/jonathanzeh/Library/CloudStorage/OneDrive-Personal/BA_Thesis/BA_coding/R_exports/regression_outputs/"
  
  output_path = paste0(folder_path, subfolder, "/", file_name)
  
  ######################## title string
  string_representation <- sapply(sub_sample, 
                                  function(x) paste(x, collapse = ","))
  subsample_string <- paste(string_representation, collapse = "; ")
  title <- paste(title, "Sub Sample:", subsample_string)
  
  ######################## variable labels
  variable_labels <- c(final_monthly_std_dev = "Daily Volatility", 
                       min_monthly_return = "5% Left Tail",
                       max_monthly_return = "5% Right Tail",
                       skewness = "Skewness",
  final_ETF_ownership = "ETF ownership",
  log_market_cap = "log(Mktcap t-1)",
  inv_price = "1/Price t-1", 
  amihud_ratio = "Amihud t-1", 
  monthly_relative_spread = "Bid-ask spread t-1",
  price_to_BV = "Price to book t-1",
  cumulative_return_12m = "Past 12-month returns t-1",
  gross_profit = "Gross profitability t-1",
  final_FUND_ownership = "Fund ownership t-1",
  final_INDEX_FUND_ownership = "Index fund ownership t-1",
  final_ACTIVE_FUND_ownership = "Active fund ownership t-1",
  final_T1_monthly_std_dev = "Volatility t-1", 
  final_T2_monthly_std_dev = "Volatility t-2",
  final_T3_monthly_std_dev = "Volatility t-3",
  bad_times = "High VSTOXX"
  )
  
  ######################## etable
  if(all(is.na(cluster)) == FALSE){
    cluster_string = paste0("~", paste(cluster, collapse = " + "))
    etable(fe_models_list,
         cluster = cluster_string, 
         title = title,
         dict = variable_labels,
         fitstat = ~ r2 + n,
         style.df = style_df,
         digits = 3,
         view = TRUE,
         file = output_path)
  } else {
    etable(fe_models_list,
         title = title,
         dict = variable_labels,
         fitstat = ~ r2 + n,
         style.df = style_df,
         digits = 3,
         view = TRUE,
         file = output_path)
  }
}
```


## Apply Functions
## 1 - Full Sample
### Func Full Sample Model
```{r}
full_sample_function <- function(data_set){
  periode_list <- list(c(2011, 2024))
  fixed_vars <- c("stock_RIC", "month", "headquarters_country")

#################################################################
# Setup 1
#################################################################
  indep_vars <- c("final_ETF_ownership",
                "log_market_cap", "inv_price", "amihud_ratio",
                "monthly_relative_spread", "price_to_BV",
                "cumulative_return_12m")

  fe_models_list_1 <- data_on_fe_function(data_set, indep_vars, fixed_vars,
                                          periode_list, setup = "single")

#################################################################
# Setup 2
#################################################################
  indep_vars <- c("final_ETF_ownership",
                "log_market_cap", "inv_price", "amihud_ratio",
                "monthly_relative_spread", "price_to_BV",
                "cumulative_return_12m", "final_FUND_ownership")
  fe_models_list_2 <- data_on_fe_function(
  data_set, indep_vars, fixed_vars, periode_list, setup = "single")

#################################################################
# Setup 3
#################################################################
  indep_vars <- c("final_ETF_ownership",
                "log_market_cap", "inv_price", "amihud_ratio",
                "monthly_relative_spread", "price_to_BV",
                "cumulative_return_12m", "final_INDEX_FUND_ownership", 
                "final_ACTIVE_FUND_ownership")

  fe_models_list_3 <- data_on_fe_function(
  data_set, indep_vars, fixed_vars, periode_list, setup = "single")

#################################################################
# Setup 4
#################################################################
  indep_vars <- c("final_ETF_ownership",
                "log_market_cap", "inv_price", "amihud_ratio",
                "monthly_relative_spread", "price_to_BV",
                "cumulative_return_12m", "final_INDEX_FUND_ownership", 
                "final_ACTIVE_FUND_ownership", "final_T1_monthly_std_dev",
                "final_T2_monthly_std_dev", "final_T3_monthly_std_dev")

  fe_models_list_4 <- data_on_fe_function(
  data_set, indep_vars, fixed_vars, periode_list, setup = "single")

#################################################################
  combined <- list(fe_models_list_1[[1]], fe_models_list_2[[1]],
                      fe_models_list_3[[1]], fe_models_list_4[[1]])
  return(combined)
}
```

### Func Call Full Sample Model
```{r}
# monthly_panel_v1_all.csv
# ------------------------------------------------------------------
df_600_ex_50_list <- full_sample_function(df_600_ex_50)
df_600_list <- full_sample_function(df_600)
df_50_list <- full_sample_function(df_50)

merged_list <- append(df_600_list, df_50_list)
merged_list <- append(merged_list, df_600_ex_50_list)

etable_function(merged_list, cluster = c("stock_RIC", "month",
                                         "headquarters_country"),
                "Data: df_600, df_50, df_600_ex_50, Full Sample",
                sub_sample = list(c(2011, 2024)),
                              "full_sample_regressions",
                              "full_sample_final.tex")

# monthly_panel_v1_eu_all.csv
# ------------------------------------------------------------------
df_600_ex_50_eu_list <- full_sample_function(df_600_ex_50_eu)
df_600_eu_list <- full_sample_function(df_600_eu)
df_50_eu_list <- full_sample_function(df_50_eu)

merged_list <- append(df_600_eu_list, df_50_eu_list)
merged_list <- append(merged_list, df_600_ex_50_eu_list)

etable_function(merged_list, cluster = c("stock_RIC", "month", "headquarters_country"),
                              "Data: df_600_eu, df_50_eu, df_600_ex_50_eu, 
                Full Sample Europe",
                              sub_sample = list(c(2011, 2024)),
                              "full_sample_regressions_eu",
                              "full_sample_final_eu_all.tex")

```

## 2 - Sample Split
### Sample split by period
```{r}
#################################################################
# Data: df_600, df_50
#################################################################
fixed_vars <- c("stock_RIC", "month", "headquarters_country")
indep_vars <- c("final_ETF_ownership",
                "log_market_cap", "inv_price", "amihud_ratio",
                "monthly_relative_spread", 
                "price_to_BV",
                "cumulative_return_12m",
                "final_INDEX_FUND_ownership", "final_ACTIVE_FUND_ownership",
                "final_T1_monthly_std_dev", "final_T2_monthly_std_dev",
                "final_T3_monthly_std_dev")

period_list <- list(c(2011, 2015),
                    c(2015, 2020),
                    c(2020, 2024)) 

fe_models_list_50 <- data_on_fe_function(
  df_50, indep_vars, fixed_vars, period_list, setup = "lag")

fe_models_list_600 <- data_on_fe_function(
  df_600, indep_vars, fixed_vars, period_list, setup = "lag")

etable_function(append(fe_models_list_600, fe_models_list_50), 
                cluster = c("stock_RIC", "month", "headquarters_country"),
                "Data: d_600, df_50,",
                sub_sample = period_list,
                "sample_split_regressions",
                "sample_split_final.tex")

#################################################################
# Data: df_600, df_50 OMITTING FEBRUARY, MARCH, APRIL due to COVID
#################################################################
fixed_vars <- c("stock_RIC", "month", "headquarters_country")
indep_vars <- c("final_ETF_ownership",
                "log_market_cap", "inv_price", "amihud_ratio",
                "monthly_relative_spread", 
                "price_to_BV",
                "cumulative_return_12m",
                "final_INDEX_FUND_ownership", "final_ACTIVE_FUND_ownership",
                "final_T1_monthly_std_dev", "final_T2_monthly_std_dev",
                "final_T3_monthly_std_dev")

period_list <- list(c(2011, 2015),
                    c(2015, 2020),
                    c(2020, 2024)) 

fe_models_list_50 <- data_on_fe_function(
  df_50 %>%
    filter(!(year(date) == 2020 & month(date) %in% c(2, 3, 4))),
  indep_vars, fixed_vars, period_list, setup = "lag")

fe_models_list_600 <- data_on_fe_function(
  df_600 %>%
    filter(!(year(date) == 2020 & month(date) %in% c(2, 3, 4))),
  indep_vars, fixed_vars, period_list, setup = "lag")

etable_function(append(fe_models_list_600, fe_models_list_50), 
                cluster = c("stock_RIC", "month", "headquarters_country"),
                "Data: d_600, df_50,",
                sub_sample = period_list,
                "sample_split_regressions",
                "sample_split_final_table_without_COVID.tex")

#################################################################
# Data: df_600_ex_50, df_50
#################################################################

fixed_vars <- c("stock_RIC", "month", "headquarters_country")
indep_vars <- c("final_ETF_ownership",
                "log_market_cap", "inv_price", "amihud_ratio",
                "monthly_relative_spread", 
                "price_to_BV",
                "cumulative_return_12m",
                "final_INDEX_FUND_ownership", "final_ACTIVE_FUND_ownership",
                "final_T1_monthly_std_dev", "final_T2_monthly_std_dev",
                "final_T3_monthly_std_dev")

period_list <- list(c(2011, 2015),
                    c(2015, 2020),
                    c(2020, 2024)) 

fe_models_list_50 <- data_on_fe_function(
  df_50,indep_vars, fixed_vars, period_list, setup = "lag")

fe_models_list_600_ex_50 <- data_on_fe_function(
  df_600_ex_50,indep_vars, fixed_vars, period_list, setup = "lag")

etable_function(append(fe_models_list_600_ex_50, fe_models_list_50), 
                cluster = c("stock_RIC", "month", "headquarters_country"),
                "Data: d_600_ex_50, df_50,",
                sub_sample = period_list,
                "sample_split_regressions",
                "sample_split_df600ex50_df50_4.tex")
```


### Tail Risk
```{r}
fixed_vars <- c("stock_RIC", "month")
indep_vars <- c("final_ETF_ownership",
                "log_market_cap", "inv_price", "amihud_ratio",
                "monthly_relative_spread", "price_to_BV",
                "cumulative_return_12m", 
                "final_INDEX_FUND_ownership", "final_ACTIVE_FUND_ownership")

periode_vec <- c(2015, 2019)

df_600_ex_COVID <- df_600 %>%
  filter(!(year(date) == 2020 & month(date) %in% c(2, 3, 4)))

depend_var <- "min_monthly_return"
left_tail_model_600 <- fe_function(df_600, indep_vars, fixed_vars, 
                                   periode_vec, setup = "single", 
                                   depend_var = depend_var)
left_tail_model_50 <- fe_function(df_50, indep_vars, fixed_vars, 
                                  periode_vec, setup = "single", 
                                  depend_var = depend_var)

depend_var = "max_monthly_return"
right_tail_model_600 <- fe_function(df_600, indep_vars, fixed_vars,
                                    periode_vec, setup = "single", 
                                    depend_var = depend_var)
right_tail_model_50 <- fe_function(df_50, indep_vars, fixed_vars,
                               periode_vec, setup = "single", 
                               depend_var = depend_var)

depend_var <- "skewness"
skewness_model_600 <- fe_function(df_600, indep_vars, fixed_vars,
                                  periode_vec, setup = "single", 
                                  depend_var = depend_var)
skewness_model_50 <- fe_function(df_50, indep_vars, fixed_vars, 
                                 periode_vec, setup = "single", 
                                 depend_var = depend_var)

etable_function(list(left_tail_model_600, right_tail_model_600, 
                     skewness_model_600, interaction_model_600,
                     left_tail_model_50, right_tail_model_50, 
                     skewness_model_50, interaction_model_50),
                cluster = c("stock_RIC", "month"),
                              "Data: df_600",
                              sub_sample = list(c(2015, 2019)),
                              "tail_risk_models",
                              "tail_model_df_600.tex")
```

## 3 - Tail Risk
### import VIX data
```{r}
# Read data from Excel
vix_data <- read_excel("/Users/jonathanzeh/Library/CloudStorage/OneDrive-Personal/BA_Thesis/BA_coding/datasets/eikon_data/volatility_index/VSTOXX_price_data.xlsx")

vix_data[[1]] <- as.Date(vix_data[[1]], format = "%d-%b-%Y")
names(vix_data)[1] <- "date"
vix_data[[1]] <- as.Date(format(vix_data[[1]], "%Y-%m-%d"))

# Calculate the 25th percentile of the VIX index
bottom_quartile_threshold <- quantile(vix_data$Close, 0.25)

# Create a dummy variable for bad times
vix_data <- vix_data %>%
  mutate(bad_times = if_else(Close <= bottom_quartile_threshold, 1, 0))

## merge
df_600_tail_risk <- merge(df_600, vix_data[, c("date", "bad_times")], by = "date")
df_50_tail_risk<- merge(df_50, vix_data[, c("date", "bad_times")], by = "date")
```

### Tail Risk Interaction
```{r}
fixed_vars <- c("stock_RIC", "month")
indep_vars <- c("final_ETF_ownership",
                "log_market_cap", "inv_price", "amihud_ratio",
                "monthly_relative_spread", "price_to_BV",
                "cumulative_return_12m", 
                "final_INDEX_FUND_ownership", "final_ACTIVE_FUND_ownership")

periode_vec <- c(2011, 2023)

depend_var <- "skewness"
interaction_model_600 <- fe_function(df_600_tail_risk, indep_vars, 
                               fixed_vars, periode_vec, setup = "single",
                               depend_var = depend_var,
                               interaction_config = TRUE)
interaction_model_50 <- fe_function(df_50_tail_risk, indep_vars, 
                               fixed_vars, periode_vec, setup = "single",
                               depend_var = depend_var,
                               interaction_config = TRUE)
```

### Plot vix data
```{r}
plot(vix_data$date, vix_data$Close, type = "l")
abline(h = bottom_quartile_threshold, col = "red")
```

# Heatmap Figure
## Data Preparation
```{r}
# load ETF Composition
df_index <- read_csv("/Users/jonathanzeh/Library/CloudStorage/OneDrive-Personal/BA_Thesis/BA_coding/datasets/eikon_data/index_constituents_data/formated_constituents.csv")

df_index <- df_index %>%
  select(date, stock_RIC, rank_600, rank_50)

# left merge twith existing df
df_rank_raw <- df_600 %>%
  left_join(df_index, by = c("date", "stock_RIC"))

eurozone_countries <- c(
  "Austria", "Belgium", "Croatia", "Cyprus", "Estonia", "Finland",
  "France", "Germany", "Greece", "Ireland", "Italy", "Latvia",
  "Lithuania", "Luxembourg", "Malta", "Netherlands", "Portugal",
  "Slovakia", "Slovenia", "Spain"
)

df_rank_raw <- df_rank_raw %>%
  
  # this setting was not applied:
  # filter(headquarters_country %in% eurozone_countries) %>%
  
  select(stock_RIC, percent_of_traded_shares,
         INDEX_FUND_percent_of_traded_shares,
         ACTIVE_FUND_percent_of_traded_shares, market_cap, date, 
         index_member_600, index_member_50, rank_600, rank_50, 
         monthly_std_dev) %>%
  mutate(percent_of_traded_shares = lead(percent_of_traded_shares),
         INDEX_FUND_percent_of_traded_shares =
           lead(INDEX_FUND_percent_of_traded_shares),
         ACTIVE_FUND_percent_of_traded_shares =
           lead(ACTIVE_FUND_percent_of_traded_shares))

df_rank_raw <- df_rank_raw %>%
  mutate(year = as.numeric(format(date, "%Y"))) %>%
  filter(year > 2010)

df_rank_raw <- df_rank_raw %>%
  group_by(date) %>%
  mutate(market_cap_rank = dense_rank(desc(market_cap)))
```

## Heatmap Monthly
```{r}
# Use rank to create bins of stocks
# ---------------------------------------------------------------------
df_heatmap <- df_rank_raw %>%
  group_by(date) %>%
  mutate(group_rank = ceiling(rank_600 / 5) * 5) %>%
  group_by(date, group_rank) %>%
  mutate(group_num = as.factor(n()),
         ETF_ownership = mean(percent_of_traded_shares, na.rm = TRUE)/100) %>%
  ungroup() %>%
  filter(group_rank <= 600) %>%
  arrange(group_rank)

# Create rows for missing groups at dates
# ---------------------------------------------------------------------
complete_etf_ownership <- function(data, date_col, group_col, etf_col) {
  data %>%
    # Create all combinations of date and group
    complete({{ date_col }}, {{ group_col }}) %>%  
    # Replace NA with NaN
    mutate({{ etf_col }} := ifelse(is.na({{ etf_col }}), NaN, {{ etf_col }}))
}

df_heatmap <- complete_etf_ownership(df_heatmap, date, group_rank, ETF_ownership)


# Prepare Colors
# ---------------------------------------------------------------------
library(dichromat)
base_colors <- c("#2C2CFD", "#2C2CFD", "#2C2CFD", "#2C2CFD", "#2C2CFD", "#6565ED" ,"#A1A1E3" , "#C4C41C", "#D9D93D", "#FCFC2C")
safe_colors <- dichromat(base_colors, type = "deutan")
safe_colors <- rev(c("#2C2CFD", "#6565ED" ,"#A1A1E3" , "#A1A1E3", "#C4C41C", "#C4C41C", "#D9D93D", "#D9D93D", "#FCFC2C", "#FCFC2C"))

safe_colors <- rev(c("#2C2CFD", "#6565ED" ,"#A1A1E3" , "#C4C41C", "#D9D93D", "#FCFC2C"))

# ggplot2
# ---------------------------------------------------------------------
pdf("heatmap_original_ranking_2.pdf", width = 20, height = 10)
ggplot(df_heatmap, aes(x = date, y = as.numeric(group_rank), fill = group_num)) +
  geom_tile(width = 35, height = 9) +
  scale_fill_manual(values = safe_colors, na.value = "black") +
  scale_x_date(
    date_breaks = "1 year",  
    date_labels = "%Y",
    expand = c(0, 0)) +
  
  scale_y_continuous(
    breaks = seq(100, 600, by = 100),
    labels = seq(100, 600, by = 100)) +
  
  labs(title = "Number of Observations Across Binned Groups of Six Ranks",
       x = "",
       y = "",
       fill = "Number of\nObserved Stocks") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 20),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 14),
        panel.grid.minor.x = element_blank())           
dev.off()


ggplot(df_heatmap, aes(x = date, y = as.numeric(group_rank), 
                       fill = ETF_ownership)) +
  geom_tile(width = 32, height = 6) +  # Tighten tiles
  scale_fill_gradient2(low = "white",high = "blue", na.value = "black",
                       limits = c(NA, 0.055),
                       oob = scales::squish,) +
  scale_x_date(
    date_breaks = "1 year",  
    date_labels = "%Y",
    expand = c(0, 0)  # Remove padding
  ) +
  scale_y_continuous(
    breaks = seq(100, 600, by = 100),
    labels = seq(100, 600, by = 100),
    expand = c(0, 0)  # Remove padding
  ) +
  labs(
    title = "ETF Ownership Across Binned Groups of 10 Ranks",
    x = "",
    y = "",
    fill = "ETF Ownership"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 15),
    axis.text.y = element_text(size = 15),
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    plot.title = element_text(size = 15, face = "bold", hjust = 0.5),
    legend.title = element_text(size = 15),
    legend.text = element_text(size = 14),
    panel.grid.minor.x = element_blank()
  )
dev.off()

```

## Ownership Heatmap Quarterly
```{r}
library(lubridate)

# Create bins 
# ---------------------------------------------------------------------
df_heatmap <- df_rank_raw %>%
  mutate(quarter_year = as.Date(paste(year(date), 
                           (quarter(date) - 1) * 3 + 1, "01", sep="-"))) %>%
  group_by(date) %>%
  mutate(group_rank = ceiling(rank_600 / 20) * 20) %>%
  filter(group_rank <= 600) %>%
  group_by(date, group_rank) %>%
  mutate(group_num = n()) %>%

  arrange(date) %>%
  group_by(group_rank) %>%
  mutate(lag_group_rank = lag(group_rank),
         lag_percent_of_traded_shares = lag(percent_of_traded_shares))
  
# Take the average of bins with the same rank across each quarter
# ---------------------------------------------------------------------
df_heatmap <- df_heatmap %>%
  group_by(quarter_year, group_rank) %>%
  summarize(mean_ETF_ownership = mean(percent_of_traded_shares, na.rm = T),
            lag_mean_ETF_ownership = mean(lag_percent_of_traded_shares, 
                                          na.rm = T),
            diff_mean_ETF_ownership = 
              (mean_ETF_ownership/lag_mean_ETF_ownership - 1),
            mean_volatility = mean(monthly_std_dev, na.rm = T),
            quarter_group_num = sum(group_num)) %>%
  ungroup() 

df_heatmap <- df_heatmap %>%
  mutate(quarter_group_num = as.factor(quarter_group_num))

# Calculate delate in ownership of group
# ---------------------------------------------------------------------
df_heatmap <- df_heatmap %>%
  mutate(group_rank = as.factor(group_rank))

df_heatmap <- df_heatmap %>%
  arrange(quarter_year)

df_heatmap <- df_heatmap %>%
  group_by(group_rank) %>%
  mutate(change_quarterly_ETF_ownership = (mean_ETF_ownership / lag(mean_ETF_ownership)) - 1)

df_heatmap <- df_heatmap %>%
  mutate(
    discrete_change_quarterly_ETF_ownership = case_when(
      change_quarterly_ETF_ownership > 0.2 ~ "> 20%",
      change_quarterly_ETF_ownership > 0.1 ~ "10-20%",
      change_quarterly_ETF_ownership > 0.05 ~ "5-10%",
      change_quarterly_ETF_ownership > 0 ~ "> 0%",
      change_quarterly_ETF_ownership > -0.05 ~ "0 - (-5%)",
      TRUE ~ "< -5%"  # Catch-all for changes <= -0.05
    )
  )
```


## Number of Observations Plot
```{r}
pdf("heatmap_quarterly_observations_v2.pdf", width = 12, height = 7)
ggplot(df_heatmap, aes(x = quarter_year, y = as.numeric(group_rank), 
                       fill = quarter_group_num)) +
  theme_minimal(base_family = "CMU Serif") +
  
  geom_tile(width = 94, height = 22) +
  scale_fill_gradient2(low = "#E9E9E9", mid = "#4730F0", high = "#4730F0",
                      midpoint = 1000,
                      na.value = "grey50",
                      guide = guide_colourbar(ticks = FALSE,
                      barwidth = 1.5,
                      barheight = 8)) +
  
  scale_x_date(
    date_breaks = "1 year",  
    date_labels = "%Y",
    expand = c(0, 0)) +
  
  scale_y_continuous(
    breaks = seq(100, 600, by = 100),
    labels = seq(100, 600, by = 100),
    expand = c(0, 0)) +
  
  labs(title = "",
       x = "",
       y = "",
       fill = "Number of\nObservations") +
  
  theme_minimal() +
  theme(text = element_text(face = "plain")) +
  
  theme(axis.text.y = element_text(margin = margin(r = 10)),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        axis.ticks = element_line(color = "grey"),
        axis.ticks.length = unit(0.3, "cm"),
        axis.ticks.length.x = unit(0.6, "cm"),) +
  
  theme(axis.text.x = element_text(
      angle = 45, hjust = 1, vjust = 1, size = 25),
        axis.text.y = element_text(size = 25),
        axis.title.x = element_text(size = 25),
        axis.title.y = element_text(size = 25),
        plot.title = element_text(size = 25, face = "bold", 
                                  hjust = 0.5, 
                                  vjust = 2),
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 18),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank())

dev.off()


# Number of Observations
# ---------------------------------------------------------------------
pdf("heatmap_group_num_bias_free_ranking_2.pdf", width = 12, height = 7)
ggplot(df_heatmap, aes(x = quarter_year, 
                       y = as.numeric(group_rank),
                       fill = quarter_group_num)) +
  
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "#E9E9E9", mid = "#503AEB", high = "#503AEB",
                       midpoint = 1000,
                      na.value = "grey50") +
  
  #mid = "#CCCCE5" high = "#6565ED" mid = "#C4C41C" high = "#1616FF"
  scale_x_date(
    date_breaks = "1 year",  
    date_labels = "%Y",
    expand = c(0, 0)) +
  
  scale_y_continuous(
    breaks = seq(100, 600, by = 100),
    labels = seq(100, 600, by = 100)) +
  
  labs(title = "Number of Observations Across Binned Groups of 20 Ranks",
       x = "",
       y = "",
       fill = "Number of\nObservations") +
  
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 20),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 14),
        panel.grid.minor.x = element_blank())   
dev.off()
```

## ETF ownership Plot
```{r}
# ETF ownership
# ---------------------------------------------------------------------
pdf("heatmap_quarterly_ETF_v8.pdf", width = 12, height = 7)
ggplot(df_heatmap, aes(x = quarter_year, y = as.numeric(group_rank), 
                       fill = mean_ETF_ownership)) +
  theme_minimal(base_family = "CMU Serif") +
  
  geom_tile(width = 94, height = 22) +
  scale_fill_gradient2(low = "white", high = "blue",
                      na.value = "grey50",
                      guide = guide_colourbar(ticks = FALSE,
                      barwidth = 1.5,
                      barheight = 8)) +
  scale_x_date(
    date_breaks = "1 year",  
    date_labels = "%Y",
    expand = c(0, 0)) +
  
  scale_y_continuous(
    breaks = seq(100, 600, by = 100),
    labels = seq(100, 600, by = 100),
    expand = c(0, 0)) +
  
  labs(title = "",
       x = "",
       y = "",
       fill = "ETF Ownership\nin Percentages") +
  
  theme_minimal() +
  theme(text = element_text(face = "plain")) +
  
  theme(axis.text.y = element_text(margin = margin(r = 10)),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        axis.ticks = element_line(color = "grey"),
        axis.ticks.length = unit(0.3, "cm"),
        axis.ticks.length.x = unit(0.6, "cm"),) +
  
  theme(axis.text.x = element_text(
      angle = 45, hjust = 1, vjust = 1, size = 25),
        axis.text.y = element_text(size = 25),
        axis.title.x = element_text(size = 25),
        axis.title.y = element_text(size = 25),
        plot.title = element_text(size = 25, face = "bold", 
                                  hjust = 0.5, 
                                  vjust = 2),
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 18),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank())

dev.off()
```


### Stock Volatility
```{r}
# stock volatility
# ---------------------------------------------------------------------
ggplot(df_heatmap, aes(x = quarter_year, y = as.numeric(group_rank), 
                       fill = mean_volatility)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "white", high = "blue",
                      na.value = "grey50") +
  scale_x_date(
    date_breaks = "1 year",  
    date_labels = "%Y",
    expand = c(0, 0)) +
  
  scale_y_continuous(
    breaks = seq(100, 600, by = 100),
    labels = seq(100, 600, by = 100)) +
  
  labs(title = "Volatility Across Binned Groups of 20 Stocks",
       x = "",
       y = "",
       fill = "Monthly Volatility") +
  
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 20),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 14),
        panel.grid.minor.x = element_blank())   
dev.off()
```


```{r}
# change in ETF ownership
# ---------------------------------------------------------------------
ggplot(df_heatmap, aes(x = quarter_year, y = as.numeric(group_rank), 
                       fill = discrete_change_quarterly_ETF_ownership)) +
  geom_tile(color = "white") +
scale_fill_manual(
  values = c(
    "> 20%" = "seagreen",        # Softer but noticeable green
    "10-20%" = "mediumseagreen", # Slightly muted green
    "5-10%" = "palegreen3",      # Softer green
    "> 0%" = "palegreen1",       # Light green
    "0 - (-5%)" = "lightgoldenrod",  # Stronger orange
    "< -5%" = "lightcoral"       # Softer red for large negative change
  ),
  na.value = "grey50"            # Grey for missing values
)+
  scale_x_date(
    date_breaks = "1 year",  
    date_labels = "%Y",
    expand = c(0, 0)
  ) +
  scale_y_continuous(
    breaks = seq(100, 600, by = 100),
    labels = seq(100, 600, by = 100)
  ) +
  labs(
    title = "Volatility Across Binned Groups of 20 Stocks",
    x = "",
    y = "",
    fill = "Change ETF Ownership"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 20),
    axis.text.y = element_text(size = 20),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    legend.title = element_text(size = 20),
    legend.text = element_text(size = 14),
    panel.grid.minor.x = element_blank()
  )
dev.off()



par(mfrow = c(1, 2))
gg_ranking
gg_ownership
```

```{r}
df_rank <- df_rank %>%
  group_by(date) %>%
  filter(market_cap_rank <= 510) %>%
  na.omit() 

df_rank <- df_rank %>%
  mutate(market_cap_rank = dense_rank(desc(market_cap))) %>%
  filter(market_cap_rank <= 500) %>%
  group_by(date) %>%
  mutate(group_rank = ceiling(market_cap_rank / 5) * 5)

df_sum <- df_rank %>%
  group_by(group_rank) %>%
  summarise(group_mean_ETF_ownership = mean(percent_of_traded_shares),
            group_mean_INDEX_FUND_ownership =
              mean(INDEX_FUND_percent_of_traded_shares),
            group_mean_ACTIVE_FUND_ownership =
              mean(ACTIVE_FUND_percent_of_traded_shares),
            group_mean_market_cap = mean(market_cap))

df_rank_ownership_summary <- df_rank %>%
  group_by(group_rank, date) %>%
  summarise(group_mean_ETF_ownership = mean(percent_of_traded_shares))
  
```

## Plot showing no IV possible
```{r}
df_averged_rank <- df_rank_raw %>%
  filter(year >= 2011 & year <= 2023) %>%
  group_by(stock_RIC) %>%
  mutate(average_stock_Rank = mean(market_cap_rank, na.rm = TRUE),
         average_ETF_ownership = mean(percent_of_traded_shares, na.rm = TRUE),
         average_INDEX_FUND_ownership = 
           mean(INDEX_FUND_percent_of_traded_shares, na.rm = TRUE),
         average_ACTIVE_FUND_ownership =
           mean(ACTIVE_FUND_percent_of_traded_shares, na.rm = TRUE))

### assigning the average rank to each group
df_averged_rank <- df_averged_rank %>%
  mutate(averaged_group_rank = ceiling(average_stock_Rank / 5) * 5) %>%
  filter(averaged_group_rank <= 500)

df_averged_rank <- df_averged_rank %>%
  group_by(averaged_group_rank) %>%
  summarise(group_ETF = mean(average_ETF_ownership),
            group_INDEX_FUND = mean(average_INDEX_FUND_ownership),
            group_ACTIVE_FUND = mean(average_ACTIVE_FUND_ownership))

pdf("averaged_ranks_2011_2023.pdf", width = 15, height = 5)
par(mfrow = c(1, 3), pty = "s", mar=c(5, 4, 4, 2), mgp=c(3, 1.5, 0))
par(cex.axis=2, cex.lab=2, cex.main=1.8)
plot(df_averged_rank$averaged_group_rank, 
     df_averged_rank$group_ETF, pch = 19,
     main = "ETFs", xlab = "", ylab = "", col = rgb(0, 0, 1, 0.5), cex = 2,
     xlim = c(1,500), ylim = c(1.5, 6), xaxt = "n")
axis(1, at = c(1, 100, 200, 300, 400, 500))

plot(df_averged_rank$averaged_group_rank,
     df_averged_rank$group_INDEX_FUND,pch = 19,
     main = "Index Funds", xlab = "", ylab = "", col = rgb(0, 0, 1, 0.5),cex = 2,
      xlim = c(1,500), ylim = c(1.5, 6), xaxt = "n") #ylim = c(2, 3.2))
axis(1, at = c(1, 100, 200, 300, 400, 500))
#axis(2, at = c(2.5, 3, 3.5, 4, 4.5))
#axis(2, at = c(2, 2.3, 2.6, 2.9, 3.2))

plot(df_averged_rank$averaged_group_rank, 
     df_averged_rank$group_ACTIVE_FUND, 
     pch = 19, col = rgb(0, 0, 1, 0.5), xlab = "", ylab = "", main = "Active Funds", cex = 2, xaxt = "n", xlim = c(1,500), ylim = c(10, 35),)
axis(1, at = c(1, 100, 200, 300, 400, 500))
#axis(2, at = c(14, 16, 18, 20, 22, 24, 26, 28, 30))
dev.off()
  
```


## Rank Ownership Summary
```{r}
library(lubridate)
df_rank_ownership_summary <- df_rank_raw %>%
    mutate(quarter_year = 
             as.Date(paste(year(date), 
                           (quarter(date) - 1) * 3 + 1, "01", sep="-"))
  )

df_rank_ownership_summary <- df_rank_ownership_summary %>%
  group_by(date) %>%
  filter(market_cap_rank <= 600) %>%
  na.omit() 

df_rank_ownership_summary <- df_rank_ownership_summary %>%
  group_by(quarter_year) %>%
  mutate(quarterly_averaged_rank = mean(market_cap_rank))

df_rank_ownership_summary <- df_rank_ownership_summary %>%
    mutate(market_cap_rank = dense_rank(desc(market_cap))) %>%
  filter(market_cap_rank <= 600) %>%
  group_by(date) %>%
  mutate(group_rank = ceiling(market_cap_rank / 15) * 15)
  
df_rank_ownership_summary <- df_rank_ownership_summary %>%
  group_by(quarter_year, group_rank) %>%
  summarise(group_mean_ETF_ownership = mean(percent_of_traded_shares))
```

## Rank Plot showing no IV possible
```{r}
pdf("full_sample_non_eu_v3.pdf", width = 15, height = 5)
par(mfrow = c(1, 3), pty = "s", mar=c(5, 4, 4, 2), mgp=c(3, 1.5, 0))
par(cex.axis=2, cex.lab=2, cex.main=1.8)
plot(df_sum$group_rank, df_sum$group_mean_ETF_ownership, pch = 19,
     main = "ETFs", xlab = "", ylab = "", col = rgb(0, 0, 1, 0.5), cex = 2,
     xlim = c(1,500), xaxt = "n")
axis(1, at = c(1, 100, 200, 300, 400, 500))

plot(df_sum$group_rank, df_sum$group_mean_INDEX_FUND_ownership,pch = 19,
     main = "Index Funds", xlab = "", ylab = "", col = rgb(0, 0, 1, 0.5),cex = 2,
      xlim = c(1,500), xaxt = "n", yaxt = "n") #ylim = c(2, 3.2))
axis(1, at = c(1, 100, 200, 300, 400, 500))
axis(2, at = c(2.5, 3, 3.5, 4, 4.5))
#axis(2, at = c(2, 2.3, 2.6, 2.9, 3.2))

plot(df_sum$group_rank, df_sum$group_mean_ACTIVE_FUND_ownership, 
     pch = 19, col = rgb(0, 0, 1, 0.5), xlab = "", ylab = "", main = "Active Funds", cex = 2, yaxt = "n", xaxt = "n", xlim = c(1,500))
axis(1, at = c(1, 100, 200, 300, 400, 500))
axis(2, at = c(14, 16, 18, 20, 22, 24, 26, 28, 30))
dev.off()
```